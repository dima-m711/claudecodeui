# P2: XSS Vulnerability in Permission Details Response Display

---
status: ready
priority: p2
issue_id: "006"
tags: [security, xss, frontend, sanitization]
dependencies: []
---

**Status**: ready
**Priority**: P2 (Important - Security)
**Issue ID**: 006
**Tags**: security, xss, frontend, sanitization

## Problem Statement

The `PermissionDetails.jsx:124-138` component renders user-modified tool input directly into the DOM without sanitization, creating an XSS vulnerability if the modified input contains malicious HTML/JavaScript.

**Evidence**:
```javascript
// PermissionDetails.jsx
<pre className="...">
  {JSON.stringify(modifiedInput, null, 2)}
</pre>
```

While `JSON.stringify()` provides some encoding, the `<pre>` tag combined with CSS can be exploited via CSS injection or if JSON parsing fails.

**Risk Level**: MEDIUM-HIGH
- Enables stored XSS if response is persisted
- Violates OWASP A03:2021 - Injection
- User-controlled data displayed without sanitization

## Findings from Agents

**Security Sentinel (Agent af22acf)**:
> "User-modified input in PermissionDetails is displayed without explicit sanitization. While React's default escaping provides some protection, complex objects with prototype pollution or CSS injection vectors may bypass this."

## Proposed Solutions

### Option 1: Use DOMPurify for Sanitization (Recommended)
**Implementation**:
```javascript
import DOMPurify from 'dompurify';

// In PermissionDetails component
const sanitizedInput = useMemo(() => {
  const jsonStr = JSON.stringify(modifiedInput, null, 2);
  return DOMPurify.sanitize(jsonStr, { ALLOWED_TAGS: [] }); // Plain text only
}, [modifiedInput]);

<pre className="...">
  {sanitizedInput}
</pre>
```

**Pros**:
- Industry-standard sanitization library
- Configurable security policies
- Handles edge cases

**Cons**:
- Adds dependency (~45KB)
- May be overkill for JSON display

**Effort**: 10 LOC + dependency
**Risk**: Low

### Option 2: Use Monaco Editor (Safe Code Display)
**Implementation**:
```javascript
import Editor from '@monaco-editor/react';

<Editor
  height="200px"
  language="json"
  value={JSON.stringify(modifiedInput, null, 2)}
  options={{
    readOnly: true,
    minimap: { enabled: false },
    lineNumbers: 'off'
  }}
/>
```

**Pros**:
- Syntax highlighting
- Built-in XSS protection
- Better UX for JSON

**Cons**:
- Larger dependency (~3MB)
- May be heavy for simple display

**Effort**: 15 LOC + dependency
**Risk**: Low

### Option 3: Escape with textContent (Minimal)
**Implementation**:
```javascript
const inputPreview = useRef(null);

useEffect(() => {
  if (inputPreview.current) {
    inputPreview.current.textContent = JSON.stringify(modifiedInput, null, 2);
  }
}, [modifiedInput]);

<pre ref={inputPreview} className="..." />
```

**Pros**:
- No dependencies
- textContent is XSS-safe

**Cons**:
- Bypasses React's virtual DOM
- Less idiomatic React pattern

**Effort**: 8 LOC
**Risk**: Low

## Technical Details

**Affected Files**:
- `src/components/PermissionDetails.jsx:124-138`
- `src/components/AskUserDetails.jsx` (similar pattern if present)

**Related Findings**:
- #004: No WebSocket input validation (compounds risk)

## Acceptance Criteria

- [ ] All user-modified input sanitized before display
- [ ] Unit test with XSS payloads (script tags, event handlers)
- [ ] No regression in JSON formatting
- [ ] Content Security Policy headers configured

**Estimated LOC**: 10 (Option 1), 15 (Option 2), 8 (Option 3)
**Estimated Effort**: 2 hours

## Work Log

### 2025-12-27 - Approved for Work
**By:** Claude Triage System
**Actions:**
- Issue approved during triage session
- Status changed from pending â†’ ready
- Ready to be picked up and worked on

**Learnings:**
- Important security issue requiring sanitization
- Recommended: DOMPurify or textContent approach (Option 1 or 3)
- Related to issue #004 (WebSocket input validation)

# Architecture Patterns: Visual Reference

## Pattern Map: Current Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PATTERN LAYERS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    PRESENTATION LAYER (React)                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚ ChatInterface  â”‚  â”‚ Sidebar        â”‚  â”‚ PermissionUI   â”‚       â”‚    â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚           â”‚                   â”‚                   â”‚                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â”‚                   â”‚                   â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           STATE MANAGEMENT LAYER (Context Pattern)                 â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  â”‚ InteractionContext   â”‚       â”‚ PermissionContext    â”‚          â”‚    â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚    â”‚
â”‚  â”‚  â”‚ - pendingInteractionsâ”‚â—€â”€â”€â”   â”‚ - pendingRequests    â”‚â—€â”€â”€â”      â”‚    â”‚
â”‚  â”‚  â”‚ - addInteraction()   â”‚   â”‚   â”‚ - enqueueRequest()   â”‚   â”‚      â”‚    â”‚
â”‚  â”‚  â”‚ - removeInteraction()â”‚   â”‚   â”‚ - handleDecision()   â”‚   â”‚      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚    â”‚
â”‚  â”‚             â”‚                â”‚              â”‚                â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â”‚      WebSocketContext                 â”‚    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â”‚      - ws: WebSocket                  â”‚    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â”‚      - messages: Message[]            â”‚    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â”‚      - currentSessionIdRef âŒ          â”‚    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚      â”‚    â”‚
â”‚  â”‚             â”‚                  â”‚                            â”‚      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â”‚                  â”‚                            â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚               PERSISTENCE LAYER (Repository Pattern)              â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚  â”‚ interactionStorage â”‚              â”‚ permissionStorage  â”‚      â”‚    â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚    â”‚
â”‚  â”‚  â”‚ âŒ sessionStorage   â”‚              â”‚ âŒ sessionStorage   â”‚      â”‚    â”‚
â”‚  â”‚  â”‚ (tab-local)        â”‚              â”‚ (tab-local)        â”‚      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚    â”‚
â”‚  â”‚  â”‚ localStorage       â”‚                                           â”‚    â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                           â”‚    â”‚
â”‚  â”‚  â”‚ âœ… permanentPerms   â”‚  (shared across tabs)                   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                             â”‚
â”‚                                                                             â”‚
â”‚                           â–²                                                 â”‚
â”‚                           â”‚ WebSocket                                       â”‚
â”‚                           â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      SERVER LAYER (Node.js)                         â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚           EVENT-DRIVEN LAYER (Observer Pattern)              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚InteractionManagerâ”‚        â”‚PermissionManager â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ extends          â”‚        â”‚ extends          â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ EventEmitter     â”‚        â”‚ EventEmitter     â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                  â”‚        â”‚                  â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ .emit('request') â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ .on('request')   â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                        â”‚                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                        â–¼                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ PermissionWebSocketHandler          â”‚        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ - clients: Map<id, ClientInfo>      â”‚        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ - broadcastPermissionRequest()      â”‚        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ - handlePermissionResponse()        â”‚        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                             â”‚                                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                â”‚                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚          PERSISTENCE LAYER (Event Sourcing - Partial)        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ JSONL Files (messages only, not interactions)  â”‚          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ âŒ Interactions lost on server restart          â”‚          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ In-Memory Store (ephemeral)                    â”‚          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ - interactionsBySession: Map                   â”‚          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ - pendingInteractions: Map                     â”‚          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
  âœ… = Good pattern implementation
  âŒ = Anti-pattern or issue
  â—€â”€â”€â–¶ = Bidirectional communication
  â”€â”€â”€â–¶ = Unidirectional flow
```

---

## Anti-Pattern Visualization: Race Condition

```
Timeline: User Switches from Session A to Session B
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

T0: User in Session A
    URL: /session/abc-123
    currentSessionIdRef.current = 'abc-123'
    InteractionContext.sessionIds = ['abc-123']
    pendingInteractions = [{ id: 'int-1', sessionId: 'abc-123' }]

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tab       â”‚   Session A active
    â”‚             â”‚   Interaction 'int-1' visible
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T1: User clicks Session B in sidebar
    Action: navigate('/session/xyz-789')

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tab       â”‚   URL changing...
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T2: React Router updates
    URL: /session/xyz-789  âœ…
    BUT: useParams() hasn't propagated yet

    currentSessionIdRef.current = 'abc-123'  âŒ STALE!

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tab       â”‚   Router updated
    â”‚             â”‚   But ref still 'abc-123'
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T3: InteractionContext receives new sessionIds prop
    InteractionContext.sessionIds = ['xyz-789']  âœ…

    useEffect(() => {
      // Clear state for new session
      setPendingInteractions([]);  âŒ State cleared!

      // Load from storage
      const stored = getPendingInteractions(['xyz-789']);
      setPendingInteractions(stored);  // []
    }, [sessionIds]);

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tab       â”‚   State cleared
    â”‚             â”‚   Loading new session...
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T4: WebSocket message arrives (for Session B)
    Message: { type: 'interaction-request', sessionId: 'xyz-789', ... }

    WebSocket handler:
    if (data.sessionId === currentSessionIdRef.current) {  âŒ FAILS!
      // 'xyz-789' !== 'abc-123'
      // Message filtered out!
    }

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tab       â”‚   âŒ Message lost!
    â”‚             â”‚   Ref still has old value
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T5: setSessionId finally called
    currentSessionIdRef.current = 'xyz-789'  âœ… (too late)

    BUT: Message already filtered out at T4!

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tab       â”‚   Session B loaded
    â”‚             â”‚   Interaction missing ğŸ’¥
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ROOT CAUSE:
  Imperative ref (`currentSessionIdRef`) updated separately from React state.
  WebSocket message filtering uses ref value, which can be stale during
  React's render/commit phase.

SOLUTION:
  Replace ref with React state:
    const [currentSessionId, setCurrentSessionId] = useState(null);

  Ensure state updates are synchronous with route changes.
```

---

## Pattern: God Object (InteractionContext)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    InteractionContext                            â”‚
â”‚                  (205 lines - GOD OBJECT)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  RESPONSIBILITY 1: State Management                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚  - pendingInteractions: Interaction[]                           â”‚
â”‚  - sessionIds: string[]                                          â”‚
â”‚                                                                  â”‚
â”‚  RESPONSIBILITY 2: CRUD Operations                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚  - addInteraction(interaction)                                   â”‚
â”‚  - removeInteraction(interactionId)                              â”‚
â”‚  - updateInteraction(interactionId, updates)                     â”‚
â”‚                                                                  â”‚
â”‚  RESPONSIBILITY 3: Filtering & Queries                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚  - getInteractionsByType(type)                                   â”‚
â”‚  - getInteractionById(id)                                        â”‚
â”‚  - getInteractionsBySession(sessionId)                           â”‚
â”‚  - getInteractionCountBySession(sessionId)                       â”‚
â”‚                                                                  â”‚
â”‚  RESPONSIBILITY 4: Persistence                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  - savePendingInteraction(sessionId, interaction)                â”‚
â”‚  - removePendingInteraction(sessionId, interactionId)            â”‚
â”‚  - clearAllInteractions(sessionId)                               â”‚
â”‚                                                                  â”‚
â”‚  RESPONSIBILITY 5: Session Logic                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  - useEffect(() => {                                             â”‚
â”‚      // Session change detection                                â”‚
â”‚      // Load from storage                                        â”‚
â”‚      // Filter by session                                        â”‚
â”‚    }, [sessionIds]);                                             â”‚
â”‚                                                                  â”‚
â”‚  RESPONSIBILITY 6: Computed Values                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  - permissionCount                                               â”‚
â”‚  - planApprovalCount                                             â”‚
â”‚  - askUserCount                                                  â”‚
â”‚  - totalCount                                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VIOLATION: Single Responsibility Principle
```

### Refactored Structure (Recommended)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   InteractionProvider (Orchestrator)               â”‚
â”‚                          (50 lines)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Uses:                                                             â”‚
â”‚  - useInteractionStore()      (state management)                   â”‚
â”‚  - useInteractionPersistence() (storage)                           â”‚
â”‚  - useSessionSync()           (session change handling)            â”‚
â”‚  - useInteractionSelectors()  (computed values)                    â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚                   â”‚
            â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InteractionStore â”‚  â”‚ Persistence Hook â”‚  â”‚ SessionSync Hook â”‚
â”‚ (state only)     â”‚  â”‚ (storage only)   â”‚  â”‚ (routing only)   â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚ - add()          â”‚  â”‚ - save()         â”‚  â”‚ - onSessionChangeâ”‚
â”‚ - remove()       â”‚  â”‚ - load()         â”‚  â”‚ - syncState()    â”‚
â”‚ - update()       â”‚  â”‚ - clear()        â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Pattern: Event Flow (Permission Request)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PERMISSION REQUEST FLOW                            â”‚
â”‚              (Observer + Command + Event Emitter)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER ACTION: Claude Code needs to run `bash` tool
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: claude-sdk.js                                           â”‚
â”‚                                                                 â”‚
â”‚ await permissionManager.requestPermission({                     â”‚
â”‚   toolName: 'bash',                                             â”‚
â”‚   input: { command: 'ls -la' }                                  â”‚
â”‚ });                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: PermissionManager (EventEmitter)                        â”‚
â”‚                                                                 â”‚
â”‚ requestPermission(request) {                                    â”‚
â”‚   const requestId = uuid();                                     â”‚
â”‚   this.pendingRequests.set(requestId, request);                 â”‚
â”‚   this.emit('permission-request', { requestId, ...request });   â”‚
â”‚   return new Promise(...);  // Waits for response               â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ emit('permission-request')
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: PermissionWebSocketHandler                              â”‚
â”‚                                                                 â”‚
â”‚ permissionManager.on('permission-request', (request) => {       â”‚
â”‚   this.broadcastPermissionRequest(request);                     â”‚
â”‚ });                                                             â”‚
â”‚                                                                 â”‚
â”‚ broadcastPermissionRequest(request) {                           â”‚
â”‚   const message = {                                             â”‚
â”‚     type: 'permission-request',                                 â”‚
â”‚     requestId: request.id,                                      â”‚
â”‚     toolName: request.toolName,                                 â”‚
â”‚     input: request.input                                        â”‚
â”‚   };                                                            â”‚
â”‚   clients.forEach(client => client.ws.send(JSON.stringify(message)));â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ WebSocket broadcast
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Tab A        â”‚   Tab B        â”‚   Tab C
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT: useWebSocket hook                                       â”‚
â”‚                                                                 â”‚
â”‚ websocket.onmessage = (event) => {                              â”‚
â”‚   const data = JSON.parse(event.data);                          â”‚
â”‚   if (data.type === 'permission-request') {                     â”‚
â”‚     permissionWebSocketClient.handleMessage(data);              â”‚
â”‚   }                                                             â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT: usePermissions hook                                     â”‚
â”‚                                                                 â”‚
â”‚ useEffect(() => {                                               â”‚
â”‚   wsClient.addMessageListener((message) => {                    â”‚
â”‚     if (message.type === 'permission-request') {                â”‚
â”‚       const request = { /* parse message */ };                  â”‚
â”‚                                                                 â”‚
â”‚       // Check for auto-approval                                â”‚
â”‚       const result = enqueueRequest(request);                   â”‚
â”‚                                                                 â”‚
â”‚       if (result.autoApproved) {                                â”‚
â”‚         sendPermissionResponse(request.id, 'allow');            â”‚
â”‚       } else {                                                  â”‚
â”‚         setIsDialogOpen(true);  // Show UI                      â”‚
â”‚       }                                                         â”‚
â”‚     }                                                           â”‚
â”‚   });                                                           â”‚
â”‚ }, [wsClient]);                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT: PermissionDialog (UI Component)                         â”‚
â”‚                                                                 â”‚
â”‚ User sees:                                                      â”‚
â”‚   "Claude Code wants to use bash"                               â”‚
â”‚   Command: ls -la                                               â”‚
â”‚   [Deny] [Allow Once] [Allow for Session] [Always Allow]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ User clicks "Allow"
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT: usePermissions.handleDialogDecision()                   â”‚
â”‚                                                                 â”‚
â”‚ handleDialogDecision(requestId, 'allow') {                      â”‚
â”‚   handleDecision(requestId, 'allow');  // Update context        â”‚
â”‚   sendPermissionResponse(requestId, 'allow');  // Send to serverâ”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ WebSocket send
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: PermissionWebSocketHandler                              â”‚
â”‚                                                                 â”‚
â”‚ handlePermissionResponse(clientId, message) {                   â”‚
â”‚   this.emit('permission-response', {                            â”‚
â”‚     requestId: message.requestId,                               â”‚
â”‚     decision: message.decision                                  â”‚
â”‚   });                                                           â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ emit('permission-response')
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: PermissionManager                                       â”‚
â”‚                                                                 â”‚
â”‚ resolveRequest(requestId, decision) {                           â”‚
â”‚   const request = this.pendingRequests.get(requestId);          â”‚
â”‚   request.resolve(decision);  // Resolves Promise               â”‚
â”‚   this.pendingRequests.delete(requestId);                       â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: claude-sdk.js                                           â”‚
â”‚                                                                 â”‚
â”‚ const decision = await permissionManager.requestPermission(...);â”‚
â”‚ if (decision === 'allow') {                                     â”‚
â”‚   // Execute bash tool                                          â”‚
â”‚   const result = await executeBashTool(input);                  â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PATTERNS APPLIED:
  âœ“ Command Pattern - Message types as commands
  âœ“ Observer Pattern - WebSocket event listeners
  âœ“ Event Emitter - Server-side event bus
  âœ“ Promise/Async - Request/response correlation
  âœ“ Broadcast - Multi-client notification
```

---

## Pattern: Storage Duplication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DUPLICATION: Storage Functions                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FILE: interactionStorage.js
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY_PREFIX = 'claude-ui:interactions:';
const INTERACTION_TTL_MS = 60 * 60 * 1000;

export function getPendingInteractions(sessionIds) {
  const allInteractions = [];
  for (const sessionId of sessionIds) {
    const key = `${STORAGE_KEY_PREFIX}${sessionId}`;
    const stored = sessionStorage.getItem(key);
    const interactions = JSON.parse(stored);

    // TTL filtering
    return interactions.filter(i =>
      Date.now() - i.requestedAt < INTERACTION_TTL_MS
    );
  }
}

export function savePendingInteraction(sessionId, interaction) {
  const key = `${STORAGE_KEY_PREFIX}${sessionId}`;
  const existing = getPendingInteractions([sessionId]);
  const updated = [...existing.filter(i => i.id !== interaction.id), interaction];
  sessionStorage.setItem(key, JSON.stringify(updated));
}

FILE: permissionStorage.js
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY_PREFIX = 'claude-ui:permissions:';  // âŒ DUPLICATE
const REQUEST_TTL_MS = 60 * 60 * 1000;                // âŒ DUPLICATE

export function getPendingRequests(sessionId) {      // âŒ DUPLICATE LOGIC
  const key = `${STORAGE_KEY_PREFIX}${sessionId}`;
  const stored = sessionStorage.getItem(key);
  const requests = JSON.parse(stored);

  // TTL filtering (SAME AS ABOVE!)
  return requests.filter(r =>
    Date.now() - r.timestamp < REQUEST_TTL_MS
  );
}

export function savePendingRequest(sessionId, request) {  // âŒ DUPLICATE LOGIC
  const key = `${STORAGE_KEY_PREFIX}${sessionId}`;
  const existing = getPendingRequests(sessionId);
  const updated = [...existing.filter(r => r.id !== request.id), request];
  sessionStorage.setItem(key, JSON.stringify(updated));
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REFACTORED: baseStorage.js                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

export class SessionStorage {
  constructor(prefix, ttl = 60 * 60 * 1000) {
    this.prefix = prefix;
    this.ttl = ttl;
  }

  getKey(sessionId) {
    return `${this.prefix}${sessionId}`;
  }

  getAll(sessionIds) {
    return sessionIds.flatMap(sessionId => {
      const key = this.getKey(sessionId);
      const stored = sessionStorage.getItem(key);
      if (!stored) return [];

      try {
        const items = JSON.parse(stored);
        return items.filter(item =>
          Date.now() - item.timestamp < this.ttl
        );
      } catch (e) {
        sessionStorage.removeItem(key);
        return [];
      }
    });
  }

  save(sessionId, item) {
    const key = this.getKey(sessionId);
    const existing = this.getAll([sessionId]);
    const updated = [
      ...existing.filter(i => i.id !== item.id),
      { ...item, timestamp: item.timestamp || Date.now() }
    ];
    sessionStorage.setItem(key, JSON.stringify(updated));
  }

  remove(sessionId, itemId) {
    const key = this.getKey(sessionId);
    const existing = this.getAll([sessionId]);
    const updated = existing.filter(i => i.id !== itemId);
    if (updated.length > 0) {
      sessionStorage.setItem(key, JSON.stringify(updated));
    } else {
      sessionStorage.removeItem(key);
    }
  }

  clear(sessionId) {
    const key = this.getKey(sessionId);
    sessionStorage.removeItem(key);
  }
}

// Usage:
const interactionStorage = new SessionStorage('claude-ui:interactions:');
const permissionStorage = new SessionStorage('claude-ui:permissions:');
```

---

## Pattern: Provider Nesting (Context Hell)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CURRENT: Deep Nesting (8 levels)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

function App() {
  return (
    <ThemeProvider>                          // Level 1
      <AuthProvider>                         // Level 2
        <Router>                             // Level 3
          <WebSocketProvider>                // Level 4
            <TasksSettingsProvider>          // Level 5
              <TaskMasterProvider>           // Level 6
                <InteractionProvider>        // Level 7
                  <PermissionProvider>       // Level 8
                    <AppContent />           // Finally!
                  </PermissionProvider>
                </InteractionProvider>
              </TaskMasterProvider>
            </TasksSettingsProvider>
          </WebSocketProvider>
        </Router>
      </AuthProvider>
    </ThemeProvider>
  );
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RECOMMENDED: Flat Provider (Factory Pattern)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// providerFactory.jsx
export function combineProviders(...providers) {
  return ({ children }) => {
    return providers.reduceRight(
      (acc, Provider) => <Provider>{acc}</Provider>,
      children
    );
  };
}

// App.jsx
const AppProviders = combineProviders(
  ThemeProvider,
  AuthProvider,
  WebSocketProvider,
  TasksSettingsProvider,
  TaskMasterProvider,
  InteractionProvider,
  PermissionProvider
);

function App() {
  return (
    <Router>
      <AppProviders>
        <AppContent />
      </AppProviders>
    </Router>
  );
}

BENEFITS:
  âœ“ Cleaner code
  âœ“ Easier to reorder providers
  âœ“ Explicit dependencies
  âœ“ Better testability
```

---

## Pattern Scorecard

| Category | Pattern | Score | Notes |
|----------|---------|-------|-------|
| **State Management** | Context API | 7/10 | Too many contexts, but well-structured |
| **State Management** | useReducer | 0/10 | Not used (could help with complex state) |
| **Real-Time Sync** | WebSocket Observer | 5/10 | Works but has race conditions |
| **Real-Time Sync** | Pub/Sub | 3/10 | Server has it, client doesn't |
| **Real-Time Sync** | Event Sourcing | 4/10 | Partial (events not persisted) |
| **Persistence** | Repository Pattern | 6/10 | Good abstraction, wrong storage (sessionStorage) |
| **Persistence** | localStorage | 8/10 | Used correctly for permanent permissions |
| **Persistence** | sessionStorage | 2/10 | âŒ Wrong choice for cross-tab data |
| **Server** | Event Emitter | 9/10 | Excellent decoupling |
| **Server** | Command Pattern | 8/10 | Well-defined message types |
| **Error Handling** | Try/Catch | 7/10 | Good coverage |
| **Error Handling** | Error Boundaries | 3/10 | Only one boundary, needs more |
| **Error Handling** | Circuit Breaker | 0/10 | Missing |
| **Testing** | Unit Tests | ?/10 | Not analyzed |
| **Architecture** | Separation of Concerns | 6/10 | Good layers but violations exist |
| **Code Quality** | DRY | 5/10 | Significant duplication in storage |
| **Code Quality** | SOLID | 5/10 | SRP violated in contexts |

**Overall Architecture Score: 5.8/10**

---

## Recommended Pattern Adoption Priority

### Phase 1: Critical (Weeks 1-2)
1. âœ… **Server-Side State** - Replace sessionStorage with server-side InteractionStore
2. âœ… **Reactive Session Tracking** - Replace `currentSessionIdRef` with React state
3. âœ… **Error Boundaries** - Add boundaries around contexts

### Phase 2: High (Weeks 3-4)
4. âœ… **Unified Storage** - Create `baseStorage.js` to eliminate duplication
5. âœ… **Context Refactoring** - Split InteractionContext responsibilities
6. âœ… **Provider Factory** - Flatten provider nesting

### Phase 3: Medium (Weeks 5-6)
7. âœ… **BroadcastChannel** - Add cross-tab sync for same-browser
8. âœ… **Event Sourcing** - Persist interactions to JSONL
9. âœ… **Circuit Breaker** - Add exponential backoff to WebSocket reconnection

### Phase 4: Enhancement (Weeks 7-8)
10. âœ… **Optimistic Updates** - Improve perceived performance
11. âœ… **Idempotency** - Add keys to prevent duplicate operations
12. âœ… **Protocol Versioning** - Future-proof WebSocket messages

---

**Document Version:** 1.0
**Last Updated:** 2024-12-24
**Next Review:** After Phase 1 completion